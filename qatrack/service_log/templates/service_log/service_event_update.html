{% extends "service_log/sl_base.html" %}

{% load widget_tweaks %}
{% load qa_tags %}

{% block head_title %}Service Event{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <link href="{{ STATIC_URL }}daterangepicker/css/daterangepicker.css?v={{ VERSION }}" rel="stylesheet">
    <link href="{{ STATIC_URL }}select2/css/select2.min.css?v={{ VERSION }}" rel="stylesheet">
    <link href="{{ STATIC_URL }}qatrack_core/css/tables.css?v={{ VERSION }}" rel="stylesheet">
    <link href="{{ STATIC_URL }}qatrack_core/css/custom-select2.css?v={{ VERSION }}" rel="stylesheet">
{% endblock extra_css %}

{% block extra_js %}
    <script type="text/javascript">
        var se_colours_dict = {{ service_event_tag_colours|safe }};
        var status_colours_dict = {{ status_tag_colours|safe }};
    </script>
{% endblock extra_js %}

{% block require_javascript %}
    require(['sl_se']);
{% endblock require_javascript %}

{% block body %}

    <form action="" method="post" novalidate>
        {% csrf_token %}
        <div class="max-width-lg">
            <div class="row">
                <div class="col-md-3">
                    {% if form.instance.id %}
                        <h3 class="no-margin-top">Edit Service Event {{ form.instance.id }}</h3>
                    {% else %}
                        <h3 class="no-margin-top">Create Service Event</h3>
                    {% endif %}
                </div>
                <div class="col-md-8">
                    {% if form.instance.id %}
                        <div class="col-sm-4">
                            <dl>
                                <dt>Created:</dt>
                                <dd>
                                    <div>{{ form.instance.datetime_created }}</div>
                                    <div>by {{ form.instance.user_created_by }}</div>
                                </dd>
                            </dl>
                        </div>
                        {% if form.instance.datetime_modified %}
                            <div class="col-sm-4">
                                <dl>
                                    <dt>Modified:</dt>
                                    <dd>
                                        <div>{{ form.instance.datetime_modified }}</div>
                                        <div>by {{ form.instance.user_modified_by }}</div>
                                    </dd>
                                </dl>
                            </div>
                        {% endif %}
                        {% if form.instance.datetime_status_changed %}
                            <div class="col-sm-4">
                                <dl>
                                    <dt>Status Changed:</dt>
                                    <dd>
                                        <div>{{ form.instance.datetime_status_changed }}</div>
                                        <div>by {{ form.instance.user_status_changed_by }}</div>
                                    </dd>
                                </dl>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <div class="box box-primary">
                        <div class="box-header">

                        </div>
                        <div class="box-body">
                            <div class="row">
                                <div id="required-fields" class="col-md-6 form-horizontal">

                                    {% for field in form.fieldsets.required_fields %}
                                        <div class="form-group {% if field.errors %}has-error{% endif %}">
                                            {% if 'autosize' in field.field.widget.attrs.class %}
                                                <div class="col-sm-12">
                                                    <label for="{{ field.id_for_label }}" class="">{{ field.label }}</label>
                                                    {{ field|add_class:form.classes }}
                                                    {% for e in field.errors %}
                                                        <div class="col-sm-12 help-block text-center">{{ e }}</div>
                                                    {% endfor %}
                                                </div>
                                            {% else %}
                                                <label for="{{ field.id_for_label }}" class="col-sm-4">{{ field.label }}</label>
                                                <div class="col-sm-8">
                                                    {{ field|add_class:form.classes }}
                                                </div>
                                                {% for e in field.errors %}
                                                    <div class="col-sm-12 help-block text-center">{{ e }}</div>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>

                                <div id="optional-fields" class="col-md-6 form-horizontal">

                                    {% for field in form.fieldsets.optional_fields %}
                                        <div class="form-group {% if field.errors %}has-error{% endif %}">
                                            {% if 'autosize' in field.field.widget.attrs.class %}
                                                <div class="col-sm-12">
                                                    <label for="{{ field.id_for_label }}" class="{% if field.field.required %} required{% endif %}">{{ field.label }}</label>
                                                    {{ field|add_class:form.classes }}
                                                    {% for e in field.errors %}
                                                        <div class="col-sm-12 help-block text-center">{{ e }}</div>
                                                    {% endfor %}
                                                </div>
                                            {% else %}
                                                <label for="{{ field.id_for_label }}" class="col-sm-4{% if field.field.required %} required{% endif %}">{{ field.label }}</label>
                                                <div class="col-sm-8">
                                                    {{ field|add_class:form.classes }}
                                                </div>
                                                {% for e in field.errors %}
                                                    <div class="col-sm-12 help-block text-center">{{ e }}</div>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">

                <div class="col-lg-4">
                    <div class="box box-primary">
                        <div class="box-header">
                            <h3 class="box-title">
                                <i class="fa fa-clock-o fa-fw" aria-hidden="true"></i>
                                Time and Hours
                            </h3>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse">
                                    <i class="fa fa-minus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="box-body">
                            <div class="row">
                                <div class="col-md-12 form-horizontal">
                                    {% for field in form.fieldsets.time_fields %}
                                        <div class="form-group {% if field.errors %}has-error{% endif %}">
                                            <label class="col-md-4" for="TODO">{{ field.label }}</label>
                                            <div class="col-md-8" title="{{ field.help_text }}">
                                                {{ field|add_class:form.classes }}
                                            </div>
                                            <div class="col-md-12">
                                                {{ field.errors }}
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>

                                <div class="col-md-12">

                                    <table class="table table-striped table-hover table-condensed table-valign-middle">
                                        <thead>
                                            {{ hours_formset.management_form }}
                                            <tr>
                                                <th>User or Third Party</th>
                                                <th>Time</th>
                                                <th>Delete</th>
                                            </tr>
                                        </thead>

                                        <tbody id="hours-tbody">

                                            {% for h_form in hours_formset.forms %}
                                                {% if h_form.instance.pk or not h_form.DELETE.widget.attrs.checked %}
                                                    <tr id="{{ h_form.prefix }}">
                                                        {{ h_form.id }}
                                                        <td class="form-group{% if h_form.user_or_thirdparty.errors %} has-error{% endif %}">
                                                            {{ h_form.user_or_thirdparty|add_class:form.classes }}
                                                            {% for e in h_form.user_or_thirdparty.errors %}
                                                                <div class="help-block">{{ e }}</div>
                                                            {% endfor %}

                                                        </td>
                                                        <td {% if h_form.time.errors %}class="has-error"{% endif %} title="{{ h_form.time.help_text }}">
                                                            {{ h_form.time|add_class:form.classes }}
                                                            {% for e in h_form.time.errors %}
                                                                <div class="help-block">{{ e }}</div>
                                                            {% endfor %}
                                                        </td>
                                                        <td>
                                                            {% if h_form.instance.pk %}{{ h_form.DELETE }}{% endif %}
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                            {% endfor %}

                                        </tbody>

                                        <tfoot>
                                            <tr><td>
                                                <div id="add-hours" class="btn btn-sm btn-flat btn-info" title="Add another hours object.">Add</div>
                                            </td></tr>
                                        </tfoot>

                                    </table>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-8">
                    <div class="box box-primary">
                        <div class="box-header">
                            <h3 class="box-title">
                                <i class="fa fa-pencil-square-o fa-fw" aria-hidden="true"></i>
                                QA Followups and Approvals
                            </h3>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse">
                                    <i class="fa fa-minus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="box-body">

                            <div class="row">
                                <div id="g-link-fields" class="col-md-8 form-horizontal">
                                    {% for field in form.fieldsets.g_link_fields %}
                                        <div class="form-group {% if field.errors %}has-error{% endif %}">
                                            <label for="{{ field.id_for_label }}" class="col-sm-6{% if field.field.required %} required{% endif %}">{{ field.label }}</label>
                                            <div class="col-sm-6">
                                                {{ field|add_class:form.classes }}
                                            </div>
                                            {% for e in field.errors %}
                                                <div class="col-sm-12 help-block text-center">{{ e }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12">

                                    <table class="table table-striped table-hover table-condensed table-valign-middle">
                                        <thead>
                                            {{ followup_formset.management_form }}
                                            <tr>
                                                <th style="min-width: 200px;">Test List</th>
                                                <th>Pass/Fail Status</th>
                                                <th>Review Status</th>
    {#                                            <th>Is Complete</th>#}
    {#                                            <th>Is Approved</th>#}
                                                <th>Assigned By</th>
                                                <th>Assigned Date</th>
                                                <th></th>
                                                <th>Delete?</th>
                                            </tr>
                                        </thead>

                                        <tbody id="followup-tbody">

                                            {% for f_form in followup_formset.forms %}
    {#                                            {% if f_form.instance.pk or not f_form.DELETE.widget.attrs.checked %}#}
                                                <tr id="{{ f_form.prefix }}">
                                                    {{ f_form.id }}
                                                    <td  class="form-group{% if f_form.unit_test_collection.errors %} has-error{% endif %}">
                                                        {{ f_form.unit_test_collection|add_class:form.classes }}
                                                        {% for e in f_form.unit_test_collection.errors %}
                                                            <div class="help-block">{{ e }}</div>
                                                        {% endfor %}
                                                    </td>
                                                    {% if f_form.instance.pk %}
                                                        <td>{% if f_form.instance.test_list_instance.pk %}{{ f_form.instance.test_list_instance|as_pass_fail_status:False }}{% else %}----{% endif %}</td>
                                                        <td>{% if f_form.instance.test_list_instance.pk %}{{ f_form.instance.test_list_instance|as_review_status }}{% else %}----{% endif %}</td>
    {#                                                    <td>{{ f_form.instance.is_complete }}</td>#}
    {#                                                    <td>{{ f_form.instance.is_approved }}</td>#}
                                                        <td>{{ f_form.instance.user_assigned_by }}</td>
                                                        <td>{{ f_form.instance.datetime_assigned }}</td>
                                                        <td>
                                                            {% if f_form.instance.test_list_instance.pk %}
                                                                <a href="{% url 'review_test_list_instance' pk=f_form.instance.test_list_instance.pk %}" class="btn btn-xs btn-default btn-flat">
                                                                    Review
                                                                </a>
                                                            {% else %}
                                                                <a href="{% url 'perform_qa' pk=f_form.instance.unit_test_collection.pk %}?f={{ f_form.instance.id }}" class="btn btn-xs btn-primary btn-flat">
                                                                    Perform
                                                                </a>
                                                            {% endif %}
                                                        </td>
                                                        <td>{{ f_form.DELETE }}</td>
                                                    {% else %}
                                                        <td></td>
                                                        <td></td>
                                                        <td></td>
    {#                                                    <td></td>#}
    {#                                                    <td></td>#}
                                                        <td></td>
                                                        <td></td>
                                                        <td></td>
                                                    {% endif %}
                                                </tr>
    {#                                            {% endif %}#}
                                            {% endfor %}

                                        </tbody>

                                        <tfoot>
                                            <tr><td>
                                                <div id="add-followup" class="btn btn-sm btn-flat btn-info" title="Add another QA followup object.">Add</div>
                                            </td></tr>
                                        </tfoot>

                                    </table>
                                </div>
                            </div>



                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <div class="box box-primary">
                        <div class="box-header">
                            <h3 class="box-title">
                                <i class="fa fa-cog fa-fw" aria-hidden="true"></i>
                                Parts
                            </h3>
                        </div>
                        <div class="box-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <table class="table table-hover table-bordered table-condensed">

                                        <thead>

                                        </thead>

                                        <tbody>

                                        </tbody>

                                        <tfoot>

                                        </tfoot>

                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">

            </div>

            <div class="row">
                <div class="col-md-12">
                    <input class="btn btn-flat btn-primary" type="submit" value="Save" />
                </div>
            </div>
        </div>
    </form>

    <table style="display: none;">
        <tbody id="empty-hours-form">
            {% with hours_formset.empty_form as h_form %}
                <tr id="hours-__prefix__">
                    {{ h_form.id }}
                    <td>
                        {{ h_form.user_or_thirdparty }}
                    </td>
                    <td>
                        {{ h_form.time|add_class:form.classes }}
                    </td>
                    <td>

                    </td>
                </tr>
            {% endwith %}
        </tbody>
    </table>

    <table style="display: none;">
        <tbody id="empty-followup-form">
            {% with followup_formset.empty_form as f_form %}
                <tr id="followup-__prefix__">
                    {{ f_form.id }}
                    <td  class="form-group">{{ f_form.unit_test_collection }}</td>
                    <td></td>
                    <td></td>
                    <td></td>
{#                    <td></td>#}
{#                    <td></td>#}
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            {% endwith %}
        </tbody>
    </table>


{% endblock body %}
